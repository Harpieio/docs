"use strict";(self.webpackChunkharpie_docs=self.webpackChunkharpie_docs||[]).push([[7563],{642:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>d,default:()=>h,frontMatter:()=>t,metadata:()=>c,toc:()=>a});var r=s(4848),i=s(8453);const t={},d="Noncustodial Vault",c={id:"contracts/noncustodial-vault",title:"Noncustodial Vault",description:"The Vault contract receives tokens from Transferer and allows users to withdraw those tokens at a later time. To withdraw those tokens, users will need to pay a fee in ETH.",source:"@site/docs/contracts/noncustodial-vault.md",sourceDirName:"contracts",slug:"/contracts/noncustodial-vault",permalink:"/docs/contracts/noncustodial-vault",draft:!1,unlisted:!1,tags:[],version:"current",frontMatter:{},sidebar:"docSidebar",previous:{title:"Transferer",permalink:"/docs/contracts/transferer"},next:{title:"Audit",permalink:"/docs/contracts/audit"}},l={},a=[{value:"Roles",id:"roles",level:2},{value:"Withdrawal Functions",id:"withdrawal-functions",level:2},{value:"Recipient Address Functions",id:"recipient-address-functions",level:2},{value:"Log Functions",id:"log-functions",level:2},{value:"FeeController Functions",id:"feecontroller-functions",level:2},{value:"Emergency Functions",id:"emergency-functions",level:2}];function o(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h1,{id:"noncustodial-vault",children:"Noncustodial Vault"}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"Vault"})," contract receives tokens from ",(0,r.jsx)(n.code,{children:"Transferer"})," and allows users to withdraw those tokens at a later time. To withdraw those tokens, users will need to pay a fee in ETH."]}),"\n",(0,r.jsx)(n.p,{children:"Below is a function-by-function explanation of the code."}),"\n",(0,r.jsx)(n.h2,{id:"roles",children:"Roles"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"User Roles"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-solidity",children:"mapping(address => address) private _recipientAddress;\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Each user on Harpie will have a registered ",(0,r.jsx)(n.code,{children:"recipientAddress"})," that is able to withdraw their tokens transferred in by ",(0,r.jsx)(n.code,{children:"Transferer"}),"."]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Contract-wide Roles"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-solidity",children:"address private immutable transferer; // set during construction\naddress payable private feeController;\naddress private immutable serverSigner; // set during construction\naddress private immutable emergencyFeeRemover; // set during construction\n"})}),"\n",(0,r.jsx)(n.p,{children:"There are four contract-wide roles (one dynamic, three immutable and set during construction) in this contract:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"transferer"})," is the address of the associated ",(0,r.jsx)(n.a,{href:"/docs/contracts/transferer",children:"Transferer"})]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"feeController"})," is an address controlled by Harpie that's able to withdraw payments users have deposited and reduce individual users' fees"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"serverSigner"})," is an address that we use to validate requests by users to change their ",(0,r.jsx)(n.code,{children:"recipientAddress"})]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"emergencyFeeRemover"})," is an address of a multi-signature wallet that activates our ",(0,r.jsx)(n.a,{href:"#emergency-functions",children:"Emergency Functions"}),", and this multi-sig has majority control by custodians outside the Harpie team"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"withdrawal-functions",children:"Withdrawal Functions"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-solidity",children:"function withdrawERC721(\n    address _originalAddress,\n    address _erc721Address,\n    uint256 _id\n) payable external\n\nfunction withdrawERC20(\n    address _originalAddress,\n    address _erc20Address\n) payable external\n"})}),"\n",(0,r.jsxs)(n.p,{children:["These functions are only callable by a users' ",(0,r.jsx)(n.code,{children:"recipientAddress"}),", and allow the ",(0,r.jsx)(n.code,{children:"recipientAddress"})," to withdraw their tokens."]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Caller must pay a fee in ETH to withdraw, currently set to 0"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"recipient-address-functions",children:"Recipient Address Functions"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-solidity",children:"function setupRecipientAddress(address _recipient) external\n\nfunction changeRecipientAddress(\n    bytes memory _signature,\n    address _newRecipientAddress,\n    uint256 expiry\n) external\n"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"setupRecipientAddress"})," can only be called once by a user to set up their initial ",(0,r.jsx)(n.code,{children:"recipientAddress"})]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"changeRecipientAddress"})," can be called by a user to change their ",(0,r.jsx)(n.code,{children:"recipientAddress"})]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["This requires a signature from our ",(0,r.jsx)(n.code,{children:"serverSigner"})," for additional verification"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"log-functions",children:"Log Functions"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-solidity",children:"function logIncomingERC20(\n    address _originalAddress,\n    address _erc20Address,\n    uint256 _amount,\n    uint128 _fee\n) external\n\nfunction logIncomingERC721(\n    address _originalAddress,\n    address _erc721Address,\n    uint256 _id,\n    uint128 _fee\n) external\n"})}),"\n",(0,r.jsx)(n.p,{children:"These functions store the value and fee for each user's stored tokens."}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["These functions are only callable from the ",(0,r.jsx)(n.code,{children:"Transferer"})," contract, which run from functions only callable by ",(0,r.jsx)(n.code,{children:"transferEOAs"})]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"feecontroller-functions",children:"FeeController Functions"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-solidity",children:"function reduceERC20Fee(\n    address _originalAddress,\n    address _erc20Address,\n    uint128 _reduceBy\n) external returns (uint128)\n\nfunction reduceERC721Fee(\n    address _originalAddress,\n    address _erc721Address,\n    uint256 _id,\n    uint128 _reduceBy\n) external returns (uint128)\n\nfunction withdrawPayments(uint256 _amount) external\n\nfunction changeFeeControllerRequest(address payable _newFeeController) external\n\nfunction changeFeeController() external\n"})}),"\n",(0,r.jsx)(n.p,{children:"These functions are only callable by the role feeController."}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"feeController"})," can only reduce fees, never increase them"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"They can withdraw any fees stored in the contract, but never withdraw any tokens"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"changeFeeController"})," has a timelock period of 14 days, which is begun by calling ",(0,r.jsx)(n.code,{children:"changeFeeControllerRequest"})]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"emergency-functions",children:"Emergency Functions"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-solidity",children:"function toggleEmergencyFlag(bool _newSetting) external\n\nfunction withdrawERC721WithoutFees(\n    address _originalAddress, \n    address _erc721Address, \n    uint256 _id\n) external\n\nfunction withdrawERC20WithoutFees(\n    address _originalAddress, \n    address _erc20Address\n) external\n"})}),"\n",(0,r.jsx)(n.p,{children:"These emergency functions allow users to freely withdraw their crypto irrespective of any fees. These are put in place to avoid the possibility of maliciously-set withdrawal fees created by an outside attacker."}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"toggleEmergencyFlag"})," is only callable by ",(0,r.jsx)(n.code,{children:"emergencyFeeRemover"})]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Once the flag is turned on, any user can withdraw their allocated balance without fees"}),"\n"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(o,{...e})}):o(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>d,x:()=>c});var r=s(6540);const i={},t=r.createContext(i);function d(e){const n=r.useContext(t);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:d(e.components),r.createElement(t.Provider,{value:n},e.children)}}}]);